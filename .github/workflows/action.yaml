name: ‚öôÔ∏è Vectorial Profiler - Docker Build and Runtime Validation

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: chaos4455/vectorial-profiler
      VERSION: latest
      DOCKERHUB_USERNAME: chaos4455
      FLASK_PORT: 8881

    steps:
      - name: üß± Checkout Repository (projeto-vectorial-profiler)
        uses: actions/checkout@v3

      - name: üßæ Create Dockerfile dynamically
        run: |
          cat <<'EOF' > Dockerfile
          FROM ubuntu:22.04
          ENV DEBIAN_FRONTEND=noninteractive

          RUN apt-get update && \
              apt-get upgrade -y && \
              apt-get install -y python3 python3-pip curl git net-tools iputils-ping nano supervisor && \
              pip3 install --no-cache-dir \
                flask \
                flask_cors \
                requests \
                colorama \
                psutil \
                schedule

          RUN useradd -m -s /bin/bash vectorial && \
              echo 'vectorial:vectorial' | chpasswd && \
              mkdir -p /home/vectorial/app /var/log/supervisor

          WORKDIR /home/vectorial/app
          COPY . .

          COPY supervisord.conf /etc/supervisor/supervisord.conf

          CMD ["/usr/bin/supervisord", "-n", "-c", "/etc/supervisor/supervisord.conf"]
          EOF

      - name: ‚öôÔ∏è Create supervisord.conf dynamically
        run: |
          cat <<'EOF' > supervisord.conf
          [supervisord]
          nodaemon=true
          logfile=/var/log/supervisor/supervisord.log
          pidfile=/tmp/supervisord.pid

          [program:generator]
          command=python3 /home/vectorial/app/geraprofilesv3.py
          directory=/home/vectorial/app
          autostart=true
          autorestart=false
          startsecs=5
          exitcodes=0,1
          stderr_logfile=/var/log/supervisor/generator.err.log
          stdout_logfile=/var/log/supervisor/generator.out.log

          [program:profiler]
          command=python3 /home/vectorial/app/match-profilerv3-web-dash-full-themes.py
          directory=/home/vectorial/app
          autostart=true
          autorestart=true
          startsecs=10
          stderr_logfile=/var/log/supervisor/profiler.err.log
          stdout_logfile=/var/log/supervisor/profiler.out.log
          EOF

      - name: üê≥ Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üõ†Ô∏è Build Docker Image from this repo (vectorial-profiler)
        run: |
          docker build -t $IMAGE_NAME:$VERSION .

      - name: üì§ Push Docker Image
        run: |
          docker push $IMAGE_NAME:$VERSION

      - name: üöÄ Deploy Container & Validate
        run: |
          echo 'üß™ Subindo container com o c√≥digo do projeto-vectorial-profiler...'
          docker run -d --name vectorial_profiler_test -p $FLASK_PORT:$FLASK_PORT $IMAGE_NAME:$VERSION

          echo '‚è≥ Aguardando 20 segundos para inicializa√ß√£o completa...'
          sleep 20

          echo "üîç Verificando se a porta $FLASK_PORT est√° ativa..."
          if nc -zv localhost $FLASK_PORT; then
            echo '‚úÖ Porta ativa! Servi√ßos iniciados com sucesso.'
          else
            echo '‚ùå Falha: Porta n√£o est√° respondendo ap√≥s tempo de espera.'
            docker logs vectorial_profiler_test
            exit 1
          fi

          echo 'üìú Logs do supervisord:'
          docker exec vectorial_profiler_test tail -n 50 /var/log/supervisor/supervisord.log || echo '‚ö†Ô∏è N√£o foi poss√≠vel obter logs.'

          echo 'üìú Logs do generator (erro esperado pode aparecer):'
          docker exec vectorial_profiler_test tail -n 50 /var/log/supervisor/generator.out.log || echo '‚ö†Ô∏è Sem logs do generator.'

          echo 'üìú Logs do profiler (deve estar rodando sem falhas):'
          docker exec vectorial_profiler_test tail -n 50 /var/log/supervisor/profiler.out.log || echo '‚ö†Ô∏è Sem logs do profiler.'
